<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢¨éšªè©•ä¼°è¡¨ç”Ÿæˆå™¨</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; margin: 20px; background-color: #f0f2f5; color: #333; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 20px; font-weight: 800; letter-spacing: 1px; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 98%; margin: auto; overflow-x: auto; }
        .header-inputs { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; background: #ffffff; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; }
        .header-inputs div { display: flex; flex-direction: column; min-width: 160px; flex: 1; }
        .header-inputs label { font-weight: bold; margin-bottom: 8px; font-size: 0.9rem; color: #555; }
        .header-inputs input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9; transition: 0.3s; }
        .header-inputs input:focus { border-color: #3498db; background: #fff; outline: none; }
        .toggle-bar { background: #fff3cd; color: #856404; padding: 12px 20px; border-radius: 8px; border: 1px solid #ffeeba; cursor: pointer; display: flex; align-items: center; justify-content: space-between; font-weight: bold; margin-bottom: 10px; }
        .ref-section { display: none; margin-bottom: 20px; background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #eee; border-top: 4px solid #ffc107; }
        .ref-content { display: flex; gap: 40px; flex-wrap: wrap; }
        table.main-table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 1800px; border: 1px solid #ddd; }
        th, td { border-right: 1px solid #ddd; border-bottom: 1px solid #ddd; padding: 10px; vertical-align: top; font-size: 0.9rem; }
        th { color: white; background-color: #576574; position: sticky; top: 0; z-index: 10; }
        th.sec-condition { background-color: #0097e6; }
        th.sec-hazard { background-color: #e67e22; }
        th.sec-control { background-color: #27ae60; }
        th.sec-risk { background-color: #c0392b; }
        th.sec-measure { background-color: #8e44ad; }
        .risk-cell { font-weight: 800; text-align: center; vertical-align: middle; font-size: 1.2rem; }
        .risk-5 { background-color: #ff4757; color: white; } 
        .risk-4 { background-color: #ffa502; color: white; } 
        .risk-3 { background-color: #f1c40f; color: black; } 
        .risk-2 { background-color: #2ed573; color: white; } 
        .risk-1 { background-color: #7bed9f; color: black; } 
        .btn-group { margin-top: 30px; display: flex; gap: 15px; justify-content: center; }
        button.action-btn { padding: 12px 30px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; color: white; }
        .btn-add { background-color: #20bf6b; }
        .btn-export { background-color: #3867d6; }
        .btn-clear { background-color: #95a5a6; }
        .btn-remove { background-color: #ff6b6b; padding: 6px 10px; font-size: 12px; border: none; border-radius: 4px; color: white; cursor: pointer; }
        textarea, select, input[type="text"] { width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>âœ’ï¸é¢¨éšªè©•ä¼°è¡¨ç”Ÿæˆå™¨</h1>
    <div class="header-inputs">
        <div><label>å…¬å¸åç¨±</label><input type="text" id="companyName" value="xxxxè‚¡ä»½æœ‰é™å…¬å¸"></div>
        <div><label>éƒ¨é–€</label><input type="text" id="department" placeholder="ä¾‹å¦‚: ç”Ÿç”¢éƒ¨"></div>
        <div><label>è©•ä¼°æ—¥æœŸ</label><input type="date" id="date"></div>
        <div><label>è©•ä¼°äººå“¡</label><input type="text" id="assessor" placeholder="å¡«è¡¨äººå§“å"></div>
        <div><label>å¯©æ ¸è€…</label><input type="text" id="reviewer" placeholder="ä¸»ç®¡å§“å"></div>
    </div>

    <div class="toggle-bar" onclick="toggleRef()">
        <span>åˆ†ç´šæ¨™æº–åƒè€ƒè¡¨ (å±•é–‹/æ”¶åˆ)</span>
        <span id="toggleArrow">â–¼ å±•é–‹</span>
    </div>

    <div id="refSection" class="ref-section">
        <div class="ref-content">
            <div style="flex:1"><h4>åš´é‡åº¦ (S)</h4><ul style="font-size:0.8rem"><li>S4 é‡å¤§: æ­»äº¡/å¤±èƒ½</li><li>S3 é«˜åº¦: è·æ¥­ç—…</li><li>S2 ä¸­åº¦: é€é†«</li><li>S1 è¼•åº¦: æ€¥æ•‘</li></ul></div>
            <div style="flex:1"><h4>å¯èƒ½æ€§ (P)</h4><ul style="font-size:0.8rem"><li>P4 æ¥µå¯èƒ½: >1æ¬¡/å¹´</li><li>P3 è¼ƒæœ‰å¯: 1-10å¹´1æ¬¡</li><li>P2 æœ‰å¯èƒ½: 10-100å¹´1æ¬¡</li><li>P1 ä¸å¤ªå¯: <100å¹´1æ¬¡</li></ul></div>
        </div>
    </div>

    <table id="assessmentTable" class="main-table">
        <thead>
            <tr>
                <th style="width:50px">æ“ä½œ</th>
                <th class="sec-info">1.ä½œæ¥­ç·¨è™Ÿ</th>
                <th class="sec-info">ä½œæ¥­åç¨±</th>
                <th class="sec-condition">2.ä½œæ¥­é€±æœŸ</th>
                <th class="sec-condition">ä½œæ¥­ç’°å¢ƒ</th>
                <th class="sec-condition">æ©Ÿæ¢°è¨­å‚™</th>
                <th class="sec-condition">èƒ½æº/åŒ–å­¸å“</th>
                <th class="sec-condition">ä½œæ¥­è³‡æ ¼</th>
                <th class="sec-hazard">å±å®³é¡å‹</th>
                <th class="sec-hazard">æƒ…å¢ƒæè¿°</th>
                <th class="sec-control">3.å·¥ç¨‹æ§åˆ¶</th>
                <th class="sec-control">ç®¡ç†æ§åˆ¶</th>
                <th class="sec-control">å€‹äººé˜²è­·</th>
                <th class="sec-risk">åš´é‡åº¦(S)</th>
                <th class="sec-risk">å¯èƒ½æ€§(P)</th>
                <th class="sec-risk">4.é¢¨éšªç­‰ç´š</th>
                <th class="sec-measure">5.é™ä½é¢¨éšªæªæ–½</th>
                <th class="sec-measure">æ§åˆ¶å¾ŒS</th>
                <th class="sec-measure">æ§åˆ¶å¾ŒP</th>
                <th class="sec-measure">6.æ§åˆ¶å¾Œé¢¨éšª</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="btn-group">
        <button class="action-btn btn-add" onclick="addRow()">+ æ–°å¢ä½œæ¥­é …ç›®</button>
        <button class="action-btn btn-export" onclick="exportCSV()">åŒ¯å‡º Excel CSV</button>
        <button class="action-btn btn-clear" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…ç©ºé‡ç½®</button>
    </div>
</div>

<script>
    const riskMatrix = {"S4": {"P4": 5, "P3": 4, "P2": 4, "P1": 3}, "S3": {"P4": 4, "P3": 4, "P2": 3, "P1": 3}, "S2": {"P4": 4, "P3": 3, "P2": 3, "P1": 2}, "S1": {"P4": 3, "P3": 3, "P2": 2, "P1": 1}};
    const sDesc = {"S4": "S4 é‡å¤§", "S3": "S3 é«˜åº¦", "S2": "S2 ä¸­åº¦", "S1": "S1 è¼•åº¦"};
    const pDesc = {"P4": "P4 æ¥µå¯èƒ½", "P3": "P3 è¼ƒå¯èƒ½", "P2": "P2 æœ‰å¯èƒ½", "P1": "P1 ä¸å¤ªå¯èƒ½"};

    function toggleRef() {
        const ref = document.getElementById('refSection');
        ref.style.display = (ref.style.display === 'none' || ref.style.display === '') ? 'block' : 'none';
    }

    function createOptions(optionsObj) {
        let html = '<option value="">è«‹é¸æ“‡</option>';
        for (let key in optionsObj) html += `<option value="${key}">${optionsObj[key]}</option>`;
        return html;
    }

    function addRow(data = null) {
        const tbody = document.querySelector("#assessmentTable tbody");
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td><button class="btn-remove" onclick="this.closest('tr').remove(); saveAllData();">åˆªé™¤</button></td>
            <td><input type="text" name="col_no"></td>
            <td><textarea name="col_name"></textarea></td>
            <td><input type="text" name="col2"></td>
            <td><input type="text" name="col3"></td>
            <td><textarea name="col4"></textarea></td>
            <td><textarea name="col5"></textarea></td>
            <td><textarea name="col6"></textarea></td>
            <td><input type="text" name="col7"></td>
            <td><textarea name="col8"></textarea></td>
            <td><textarea name="col9"></textarea></td>
            <td><textarea name="col10"></textarea></td>
            <td><textarea name="col11"></textarea></td>
            <td><select name="s_pre" onchange="calcRisk(this); saveAllData();">${createOptions(sDesc)}</select></td>
            <td><select name="p_pre" onchange="calcRisk(this); saveAllData();">${createOptions(pDesc)}</select></td>
            <td class="risk-cell" id="risk_pre"></td>
            <td><textarea name="col15"></textarea></td>
            <td><select name="s_post" onchange="calcRisk(this); saveAllData();">${createOptions(sDesc)}</select></td>
            <td><select name="p_post" onchange="calcRisk(this); saveAllData();">${createOptions(pDesc)}</select></td>
            <td class="risk-cell" id="risk_post"></td>
        `;
        tbody.appendChild(tr);
        if (data) {
            for (let key in data) {
                const el = tr.querySelector(`[name="${key}"]`);
                if (el) el.value = data[key];
            }
            tr.querySelectorAll('select').forEach(s => calcRisk(s));
        }
    }

    function calcRisk(element) {
        const row = element.closest('tr');
        const type = element.name.includes('pre') ? 'pre' : 'post';
        const s = row.querySelector(`select[name="s_${type}"]`).value;
        const p = row.querySelector(`select[name="p_${type}"]`).value;
        const resultCell = row.querySelector(`#risk_${type}`);
        if (s && p) {
            const level = riskMatrix[s][p];
            resultCell.textContent = level;
            resultCell.className = "risk-cell risk-" + level;
            resultCell.dataset.value = level;
        }
    }

    function saveAllData() {
        const allData = { headers: {}, rows: [] };
        document.querySelectorAll('.header-inputs input').forEach(el => { allData.headers[el.id] = el.value; });
        document.querySelectorAll('#assessmentTable tbody tr').forEach(tr => {
            const rowData = {};
            tr.querySelectorAll('input, select, textarea').forEach(el => { if(el.name) rowData[el.name] = el.value; });
            allData.rows.push(rowData);
        });
        localStorage.setItem('ral_full_backup', JSON.stringify(allData));
    }

    function clearAllData() {
        if (confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å…§å®¹å—ï¼Ÿ")) {
            localStorage.removeItem('ral_full_backup');
            location.reload();
        }
    }

    window.addEventListener('load', function() {
        const saved = localStorage.getItem('ral_full_backup');
        if (saved) {
            const allData = JSON.parse(saved);
            for (let id in allData.headers) { if(document.getElementById(id)) document.getElementById(id).value = allData.headers[id]; }
            document.querySelector("#assessmentTable tbody").innerHTML = "";
            if (allData.rows.length > 0) allData.rows.forEach(rowData => addRow(rowData));
            else addRow();
        } else { addRow(); }
        document.addEventListener('input', saveAllData);
    });

    function exportCSV() {
        saveAllData();
        const company = document.getElementById('companyName').value;
        const date = document.getElementById('date').value;
        let csv = ["å…¬å¸åç¨±," + company + ",æ—¥æœŸ," + date, "ä½œæ¥­ç·¨è™Ÿ,ä½œæ¥­åç¨±,é¢¨éšªç­‰ç´š,æ§åˆ¶å¾Œé¢¨éšª"];
        document.querySelectorAll("#assessmentTable tbody tr").forEach(tr => {
            const getVal = (name) => tr.querySelector(`[name="${name}"]`).value;
            csv.push(`${getVal("col_no")},${getVal("col_name")},${tr.querySelector('#risk_pre').textContent},${tr.querySelector('#risk_post').textContent}`);
        });
        const blob = new Blob(["\uFEFF" + csv.join("\n")], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `é¢¨éšªè©•ä¼°_${date}.csv`;
        link.click();
    }
</script>
</body>
</html>
