<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢¨éšªè©•ä¼°è¡¨ç”Ÿæˆå™¨ - è¡Œå‹•å„ªåŒ–ç‰ˆ</title>
    <link rel="manifest" href="manifest.json">
    <style>
        /* --- åŸºç¤æ¨£å¼ --- */
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 10px; background-color: #f0f2f5; color: #333; }
        h1 { color: #2c3e50; text-align: center; font-size: 1.5rem; margin-bottom: 15px; }
        .container { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); width: 100%; box-sizing: border-box; }

        /* --- é ‚éƒ¨åŸºæœ¬è³‡æ–™å„ªåŒ– --- */
        .header-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .header-inputs div { display: flex; flex-direction: column; }
        .header-inputs label { font-weight: bold; font-size: 0.85rem; margin-bottom: 5px; color: #555; }
        .header-inputs input { padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; }

        /* --- è¡¨æ ¼æ¨£å¼ (é›»è…¦ç‰ˆ) --- */
        table.main-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th { background: #2c3e50; color: white; padding: 10px; font-size: 0.9rem; white-space: nowrap; }
        td { border: 1px solid #eee; padding: 8px; }

        /* --- ğŸ“± æ‰‹æ©Ÿç‰ˆæ ¸å¿ƒæ¨£å¼ (é‡é») --- */
        @media (max-width: 768px) {
            .header-inputs { grid-template-columns: 1fr; } /* åŸºæœ¬è³‡æ–™æ”¹ç‚ºå–®æ¬„ */
            
            /* éš±è—è¡¨æ ¼æ¨™é ­ */
            thead { display: none; }
            
            /* å°‡æ¯ä¸€åˆ—è½‰ç‚ºç¨ç«‹å¡ç‰‡ */
            tr { 
                display: block; 
                background: #fff; 
                border: 2px solid #e0e0e0; 
                border-radius: 10px; 
                margin-bottom: 20px; 
                padding: 10px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            }
            
            /* å°‡æ¯å€‹å„²å­˜æ ¼è½‰ç‚ºå¸¶æœ‰æ¨™ç±¤çš„å€å¡Š */
            td { 
                display: flex; 
                flex-direction: column; 
                border: none !important; 
                padding: 5px 0 !important;
                width: 100% !important;
            }
            
            /* é€é data-label å±¬æ€§é¡¯ç¤ºæ¨™ç±¤ */
            td::before { 
                content: attr(data-label); 
                font-weight: bold; 
                color: #0097e6; 
                font-size: 0.8rem;
                margin-bottom: 3px;
            }

            input, select, textarea { 
                width: 100% !important; 
                font-size: 1rem !important; /* é¿å… iOS ç¸®æ”¾ */
                min-height: 40px !important;
            }
            
            .risk-cell { height: 50px; line-height: 50px; border-radius: 6px; }
            
            .btn-remove { width: 100%; padding: 10px; background: #ff4757; color: white; border: none; border-radius: 6px; margin-top: 10px; }
        }

        /* é¢¨éšªé¡è‰²æ¨£å¼ */
        .risk-cell { font-weight: bold; text-align: center; }
        .risk-5 { background: #ff4757; color: white; }
        .risk-4 { background: #ffa502; color: white; }
        .risk-3 { background: #f1c40f; color: black; }
        .risk-2 { background: #2ed573; color: white; }
        .risk-1 { background: #7bed9f; color: black; }

        .btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .action-btn { padding: 15px; border-radius: 8px; border: none; font-weight: bold; color: white; cursor: pointer; }
        .btn-add { background: #20bf6b; }
        .btn-export { background: #3867d6; }
        .btn-clear { background: #95a5a6; }
    </style>
</head>
<body>

<div class="container">
    <h1>âœ’ï¸ é¢¨éšªè©•ä¼°è¡Œå‹•å·¥å…·</h1>
    
    <div class="header-inputs">
        <div><label>å…¬å¸åç¨±</label><input type="text" id="companyName" value="èšé™½å¯¦æ¥­è‚¡ä»½æœ‰é™å…¬å¸"></div>
        <div><label>éƒ¨é–€</label><input type="text" id="department" placeholder="å¡«å¯«éƒ¨é–€"></div>
        <div><label>è©•ä¼°æ—¥æœŸ</label><input type="date" id="date"></div>
        <div><label>è©•ä¼°äººå“¡</label><input type="text" id="assessor" placeholder="å§“å"></div>
    </div>

    <table id="assessmentTable" class="main-table">
        <thead>
            <tr>
                <th>æ“ä½œ</th>
                <th>ä½œæ¥­åç¨±</th>
                <th>å±å®³é¡å‹</th>
                <th>S (åš´é‡)</th>
                <th>P (å¯èƒ½)</th>
                <th>é¢¨éšªç­‰ç´š</th>
                <th>æ”¹å–„æªæ–½</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="btn-group">
        <button class="action-btn btn-add" onclick="addRow()">+ æ–°å¢é …ç›®</button>
        <button class="action-btn btn-export" onclick="exportCSV()">ğŸ“¥ åŒ¯å‡º CSV å ±è¡¨</button>
        <button class="action-btn btn-clear" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
    </div>
</div>

<script>
    const riskMatrix = {"S4": {"P4": 5, "P3": 4, "P2": 4, "P1": 3}, "S3": {"P4": 4, "P3": 4, "P2": 3, "P1": 3}, "S2": {"P4": 4, "P3": 3, "P2": 3, "P1": 2}, "S1": {"P4": 3, "P3": 3, "P2": 2, "P1": 1}};

    // åœ¨ addRow ä¸­åŠ å…¥ data-label ä»¥é©é…æ‰‹æ©Ÿä»‹é¢
    function addRow(data = null) {
        const tbody = document.querySelector("#assessmentTable tbody");
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td data-label="ç®¡ç†æ“ä½œ"><button class="btn-remove" onclick="this.closest('tr').remove(); saveAllData();">åˆªé™¤æ­¤ç­†</button></td>
            <td data-label="ä½œæ¥­åç¨±"><textarea name="col_name" placeholder="ä¾‹å¦‚ï¼šè»Šç¸«ä½œæ¥­"></textarea></td>
            <td data-label="å±å®³é¡å‹"><input type="text" name="col7" placeholder="ä¾‹å¦‚ï¼šè¢«åˆºå‰²"></td>
            <td data-label="åš´é‡åº¦ (S)">
                <select name="s_pre" onchange="calcRisk(this); saveAllData();">
                    <option value="">è«‹é¸æ“‡</option>
                    <option value="S4">S4 é‡å¤§</option><option value="S3">S3 é«˜åº¦</option>
                    <option value="S2">S2 ä¸­åº¦</option><option value="S1">S1 è¼•åº¦</option>
                </select>
            </td>
            <td data-label="å¯èƒ½æ€§ (P)">
                <select name="p_pre" onchange="calcRisk(this); saveAllData();">
                    <option value="">è«‹é¸æ“‡</option>
                    <option value="P4">P4 æ¥µå¯èƒ½</option><option value="P3">P3 è¼ƒå¯èƒ½</option>
                    <option value="P2">P2 æœ‰å¯èƒ½</option><option value="P1">P1 ä¸å¤ªå¯èƒ½</option>
                </select>
            </td>
            <td data-label="è¨ˆç®—çµæœ" class="risk-cell" id="risk_pre">æœªè©•ä¼°</td>
            <td data-label="æ”¹å–„æªæ–½"><textarea name="col15" placeholder="è¼¸å…¥é è¨ˆæ”¹å–„æ–¹æ³•..."></textarea></td>
        `;
        tbody.appendChild(tr);
        if (data) {
            for (let key in data) {
                const el = tr.querySelector(`[name="${key}"]`);
                if (el) el.value = data[key];
            }
            tr.querySelectorAll('select').forEach(s => calcRisk(s));
        }
    }

    function calcRisk(element) {
        const row = element.closest('tr');
        const s = row.querySelector(`select[name="s_pre"]`).value;
        const p = row.querySelector(`select[name="p_pre"]`).value;
        const res = row.querySelector(`#risk_pre`);
        if (s && p) {
            const level = riskMatrix[s][p];
            res.textContent = level + " ç´š";
            res.className = "risk-cell risk-" + level;
        }
    }

    function saveAllData() {
        const allData = { headers: {}, rows: [] };
        document.querySelectorAll('.header-inputs input').forEach(el => { allData.headers[el.id] = el.value; });
        document.querySelectorAll('#assessmentTable tbody tr').forEach(tr => {
            const rowData = {};
            tr.querySelectorAll('input, select, textarea').forEach(el => { if(el.name) rowData[el.name] = el.value; });
            allData.rows.push(rowData);
        });
        localStorage.setItem('ral_full_backup', JSON.stringify(allData));
    }

    function clearAllData() {
        if (confirm("ç¢ºå®šè¦æ¸…ç©ºå—ï¼Ÿ")) { localStorage.removeItem('ral_full_backup'); location.reload(); }
    }

    window.addEventListener('load', function() {
        const saved = localStorage.getItem('ral_full_backup');
        if (saved) {
            const allData = JSON.parse(saved);
            for (let id in allData.headers) { if(document.getElementById(id)) document.getElementById(id).value = allData.headers[id]; }
            if (allData.rows.length > 0) allData.rows.forEach(rowData => addRow(rowData));
            else addRow();
        } else { addRow(); }
        document.addEventListener('input', saveAllData);
    });

    function exportCSV() {
        saveAllData();
        const company = document.getElementById('companyName').value;
        let csv = ["\uFEFFå…¬å¸åç¨±," + company, "ä½œæ¥­åç¨±,å±å®³é¡å‹,é¢¨éšªç­‰ç´š,æ”¹å–„æªæ–½"];
        document.querySelectorAll("#assessmentTable tbody tr").forEach(tr => {
            const getVal = (n) => tr.querySelector(`[name="${n}"]`).value;
            csv.push(`${getVal("col_name")},${getVal("col7")},${tr.querySelector('#risk_pre').textContent},${getVal("col15")}`);
        });
        const blob = new Blob([csv.join("\n")], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `é¢¨éšªè©•ä¼°_${new Date().toLocaleDateString()}.csv`;
        link.click();
    }
</script>
</body>
</html>
